"use strict";(()=>{var e={};e.id=873,e.ids=[873],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},8678:e=>{e.exports=import("pg")},3813:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{originalPathname:()=>w,patchFetch:()=>u,requestAsyncStorage:()=>d,routeModule:()=>c,serverHooks:()=>p,staticGenerationAsyncStorage:()=>m});var n=a(9303),s=a(8716),i=a(670),o=a(2054),l=e([o]);o=(l.then?(await l)():l)[0];let c=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/auth/login/route",pathname:"/api/auth/login",filename:"route",bundlePath:"app/api/auth/login/route"},resolvedPagePath:"/home/runner/work/secured-ajo/secured-ajo/app/api/auth/login/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:d,staticGenerationAsyncStorage:m,serverHooks:p}=c,w="/api/auth/login/route";function u(){return(0,i.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:m})}r()}catch(e){r(e)}})},2054:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{POST:()=>c});var n=a(2995),s=a(9434),i=a(3208),o=a(5874),l=a(2596),u=e([n]);async function c(e){try{let t=await (0,o.U0)(e);if(t)return t;let a=await e.json(),r=i.dm.safeParse(a);if(!r.success)return(0,l.sm)(r.error.format());let{email:u,password:c}=r.data,d=await (0,n.IO)(`SELECT id, email, full_name, phone, password_hash, is_verified, is_active, 
              kyc_status, failed_login_attempts, locked_until
       FROM users WHERE email = $1`,[u]);if(0===d.rows.length)return(0,l.m)("Invalid email or password");let m=d.rows[0];if(m.locked_until&&new Date(m.locked_until)>new Date){let e=Math.ceil((new Date(m.locked_until).getTime()-Date.now())/6e4);return(0,l.VR)(`Account is temporarily locked. Please try again in ${e} minutes.`,423)}if(!m.is_active)return(0,l.VR)("Account is deactivated. Please contact support.",403);if(!await (0,s.Gv)(c,m.password_hash)){let e=m.failed_login_attempts+1,t=null;return e>=5&&(t=new Date(Date.now()+18e5)),await (0,n.IO)(`UPDATE users 
         SET failed_login_attempts = $1, locked_until = $2 
         WHERE id = $3`,[e,t,m.id]),(0,l.m)("Invalid email or password")}return await (0,n.IO)(`UPDATE users 
       SET failed_login_attempts = 0, locked_until = NULL, last_login_at = CURRENT_TIMESTAMP 
       WHERE id = $1`,[m.id]),await (0,s.BV)(m.id,m.email),(0,l.Xj)({user:{id:m.id,email:m.email,fullName:m.full_name,phone:m.phone,isVerified:m.is_verified,kycStatus:m.kyc_status}},"Login successful")}catch(e){return console.error("Login error:",e),(0,l.Vd)("Failed to login")}}n=(u.then?(await u)():u)[0],r()}catch(e){r(e)}})},2596:(e,t,a)=>{a.d(t,{VR:()=>s,Vd:()=>l,Xj:()=>n,m:()=>o,sm:()=>i});var r=a(7070);function n(e,t,a=200){return r.NextResponse.json({success:!0,data:e,message:t},{status:a})}function s(e,t=400,a){return r.NextResponse.json({success:!1,error:e,...a&&{details:a}},{status:t})}function i(e){return r.NextResponse.json({success:!1,error:"Validation failed",details:e},{status:422})}function o(e="Unauthorized"){return r.NextResponse.json({success:!1,error:e},{status:401})}function l(e="Internal server error"){return r.NextResponse.json({success:!1,error:e},{status:500})}},9434:(e,t,a)=>{a.d(t,{BV:()=>h,Gv:()=>d,I_:()=>f,P:()=>g,Wx:()=>y,c_:()=>c,ts:()=>_});var r=a(8691),n=a(6890),s=a(1463),i=a(1615);let o=new TextEncoder().encode(process.env.JWT_SECRET||"your-super-secret-jwt-key-min-32-characters"),l=process.env.JWT_ACCESS_TOKEN_EXPIRY||"15m",u=process.env.JWT_REFRESH_TOKEN_EXPIRY||"7d";async function c(e){return r.ZP.hash(e,12)}async function d(e,t){return r.ZP.compare(e,t)}async function m(e,t){return await new n.N({userId:e,email:t,type:"access"}).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime(l).sign(o)}async function p(e,t){return await new n.N({userId:e,email:t,type:"refresh"}).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime(u).sign(o)}async function w(e){try{let{payload:t}=await (0,s._)(e,o);return t}catch(e){throw Error("Invalid or expired token")}}async function h(e,t){let a=await m(e,t),r=await p(e,t),n=await (0,i.cookies)();return n.set("accessToken",a,{httpOnly:!0,secure:!0,sameSite:"lax",maxAge:900,path:"/"}),n.set("refreshToken",r,{httpOnly:!0,secure:!0,sameSite:"lax",maxAge:604800,path:"/"}),{accessToken:a,refreshToken:r}}async function y(){let e=await (0,i.cookies)();e.delete("accessToken"),e.delete("refreshToken")}async function _(){try{let e=await (0,i.cookies)(),t=e.get("accessToken")?.value;if(!t)return null;return await w(t)}catch(e){return null}}function g(){return Math.floor(1e5+9e5*Math.random()).toString()}function f(){let e=new Date;return e.setMinutes(e.getMinutes()+10),e}},2995:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.d(t,{IO:()=>i,PS:()=>o});var n=a(8678),s=e([n]);if(n=(s.then?(await s)():s)[0],!process.env.DATABASE_URL)throw Error("DATABASE_URL environment variable is not set");let l=new n.Pool({connectionString:process.env.DATABASE_URL,ssl:{rejectUnauthorized:!1},max:20,idleTimeoutMillis:3e4,connectionTimeoutMillis:1e4});async function i(e,t){let a=Date.now();try{let r=await l.query(e,t),n=Date.now()-a;return console.log("Executed query",{text:e,duration:n,rows:r.rowCount}),r}catch(t){throw console.error("Database query error:",{text:e,error:t}),t}}async function o(e){let t=await l.connect();try{await t.query("BEGIN");let a=await e(t);return await t.query("COMMIT"),a}catch(e){throw await t.query("ROLLBACK"),e}finally{t.release()}}l.on("error",e=>{console.error("Unexpected error on idle client",e),process.exit(-1)}),r()}catch(e){r(e)}})},5874:(e,t,a)=>{a.d(t,{U0:()=>l,k0:()=>u});var r=a(7070);let n={},s=parseInt(process.env.RATE_LIMIT_WINDOW_MS||"900000"),i=parseInt(process.env.RATE_LIMIT_MAX_REQUESTS||"100");function o(e={}){let t=e.windowMs||s,a=e.maxRequests||i;return async e=>{let s=e.ip||e.headers.get("x-forwarded-for")||"unknown",i=Date.now();if(Object.keys(n).forEach(e=>{n[e].resetTime<i&&delete n[e]}),!n[s])return n[s]={count:1,resetTime:i+t},null;let o=n[s];if(o.resetTime<i)return o.count=1,o.resetTime=i+t,null;if(o.count>=a){let e=Math.ceil((o.resetTime-i)/1e3);return r.NextResponse.json({success:!1,error:"Too many requests",message:"You have exceeded the rate limit. Please try again later.",retryAfter:e},{status:429,headers:{"Retry-After":e.toString(),"X-RateLimit-Limit":a.toString(),"X-RateLimit-Remaining":"0","X-RateLimit-Reset":new Date(o.resetTime).toISOString()}})}return o.count++,null}}let l=o({windowMs:9e5,maxRequests:5});o({windowMs:9e5,maxRequests:100});let u=o({windowMs:6e4,maxRequests:10})},3208:(e,t,a)=>{a.d(t,{Ln:()=>i,dm:()=>s,hE:()=>u,if:()=>n,m7:()=>o,yC:()=>l});var r=a(1067);let n=r.Ry({fullName:r.Z_().min(2,"Full name must be at least 2 characters"),email:r.Z_().email("Invalid email address"),phone:r.Z_().min(10,"Phone number must be at least 10 digits"),password:r.Z_().min(8,"Password must be at least 8 characters").regex(/[A-Z]/,"Password must contain at least one uppercase letter").regex(/[a-z]/,"Password must contain at least one lowercase letter").regex(/[0-9]/,"Password must contain at least one number").regex(/[^A-Za-z0-9]/,"Password must contain at least one special character")}),s=r.Ry({email:r.Z_().email("Invalid email address"),password:r.Z_().min(1,"Password is required")}),i=r.Ry({email:r.Z_().email("Invalid email address"),otp:r.Z_().length(6,"OTP must be 6 digits")}),o=r.Ry({email:r.Z_().email("Invalid email address")});r.Ry({email:r.Z_().email("Invalid email address")}),r.Ry({token:r.Z_(),newPassword:r.Z_().min(8,"Password must be at least 8 characters").regex(/[A-Z]/,"Password must contain at least one uppercase letter").regex(/[a-z]/,"Password must contain at least one lowercase letter").regex(/[0-9]/,"Password must contain at least one number").regex(/[^A-Za-z0-9]/,"Password must contain at least one special character")});let l=r.Ry({fullName:r.Z_().min(2).optional(),phone:r.Z_().min(10).optional(),bvn:r.Z_().length(11).optional(),profileImage:r.Z_().url().optional()}),u=r.Ry({groupId:r.Z_().uuid("Invalid group ID"),amount:r.Rx().positive("Amount must be positive"),type:r.Km(["contribution","security_deposit"])});r.Ry({name:r.Z_().min(3,"Group name must be at least 3 characters"),description:r.Z_().optional(),contributionAmount:r.Rx().positive("Contribution amount must be positive"),frequency:r.Km(["daily","weekly","monthly"]),totalMembers:r.Rx().min(2).max(50),securityDepositPercentage:r.Rx().min(0).max(100),serviceFeePercentage:r.Rx().min(0).max(100).default(10),startDate:r.Z_().datetime().optional()}),r.Ry({groupId:r.Z_().uuid("Invalid group ID")})}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[276,972,795,67],()=>a(3813));module.exports=r})();