"use strict";(()=>{var e={};e.id=4,e.ids=[4],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},8678:e=>{e.exports=import("pg")},9778:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>u,requestAsyncStorage:()=>d,routeModule:()=>p,serverHooks:()=>y,staticGenerationAsyncStorage:()=>l});var o=r(9303),n=r(8716),s=r(670),i=r(9418),c=e([i]);i=(c.then?(await c)():c)[0];let p=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/payments/webhook/route",pathname:"/api/payments/webhook",filename:"route",bundlePath:"app/api/payments/webhook/route"},resolvedPagePath:"/home/runner/work/secured-ajo/secured-ajo/app/api/payments/webhook/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:d,staticGenerationAsyncStorage:l,serverHooks:y}=p,h="/api/payments/webhook/route";function u(){return(0,s.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:l})}a()}catch(e){a(e)}})},9418:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{POST:()=>c});var o=r(2995),n=r(4424),s=r(2596),i=e([o]);async function c(e){try{let t=e.headers.get("x-paystack-signature");if(!t)return(0,s.VR)("Missing signature",400);let r=await e.text();if(!(0,n.po)(r,t))return(0,s.VR)("Invalid signature",401);let a=JSON.parse(r),{event:i,data:c}=a;if(await (0,o.IO)(`INSERT INTO payment_webhooks (provider, event_type, payload, reference, processed)
       VALUES ($1, $2, $3, $4, $5)`,["paystack",i,a,c.reference,!1]),"charge.success"===i){let e=c.reference,t=c.status;if("success"===t){let t=await (0,n.m5)(e);if(!t.data||"success"!==t.data.status)return(0,s.VR)("Payment verification failed",400);return await (0,o.PS)(async t=>{let r=await t.query(`UPDATE transactions 
             SET status = 'completed', payment_reference = $1, metadata = metadata || $2
             WHERE reference = $3
             RETURNING id, user_id, group_id, type, amount, metadata`,[c.reference,JSON.stringify({paystackData:c}),e]);if(0===r.rows.length)throw Error("Transaction not found");let a=r.rows[0];"contribution"===a.type&&(await t.query(`UPDATE contributions 
               SET status = 'paid', paid_date = CURRENT_TIMESTAMP, payment_reference = $1
               WHERE transaction_ref = $2`,[c.reference,e]),await t.query(`UPDATE group_members 
               SET total_contributions = total_contributions + 1
               WHERE group_id = $1 AND user_id = $2`,[a.group_id,a.user_id])),await t.query(`INSERT INTO notifications 
             (user_id, type, title, message, group_id, metadata)
             VALUES ($1, $2, $3, $4, $5, $6)`,[a.user_id,"payment_received","Payment Successful",`Your payment of â‚¦${a.amount} has been received successfully.`,a.group_id,JSON.stringify({reference:e,amount:a.amount})]),await t.query("UPDATE payment_webhooks SET processed = TRUE, processed_at = CURRENT_TIMESTAMP WHERE reference = $1",[e])}),(0,s.Xj)(null,"Webhook processed successfully")}}return(0,s.Xj)(null,"Webhook received")}catch(t){console.error("Webhook error:",t);try{let r=await e.text(),a=JSON.parse(r);await (0,o.IO)(`UPDATE payment_webhooks 
         SET error_message = $1 
         WHERE reference = $2 AND processed = FALSE`,[t.message,a.data?.reference])}catch(e){console.error("Failed to log webhook error:",e)}return(0,s.Vd)("Failed to process webhook")}}o=(i.then?(await i)():i)[0],a()}catch(e){a(e)}})},2596:(e,t,r)=>{r.d(t,{VR:()=>n,Vd:()=>c,Xj:()=>o,m:()=>i,sm:()=>s});var a=r(7070);function o(e,t,r=200){return a.NextResponse.json({success:!0,data:e,message:t},{status:r})}function n(e,t=400,r){return a.NextResponse.json({success:!1,error:e,...r&&{details:r}},{status:t})}function s(e){return a.NextResponse.json({success:!1,error:"Validation failed",details:e},{status:422})}function i(e="Unauthorized"){return a.NextResponse.json({success:!1,error:e},{status:401})}function c(e="Internal server error"){return a.NextResponse.json({success:!1,error:e},{status:500})}},2995:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{IO:()=>s,PS:()=>i});var o=r(8678),n=e([o]);if(o=(n.then?(await n)():n)[0],!process.env.DATABASE_URL)throw Error("DATABASE_URL environment variable is not set");let c=new o.Pool({connectionString:process.env.DATABASE_URL,ssl:{rejectUnauthorized:!1},max:20,idleTimeoutMillis:3e4,connectionTimeoutMillis:1e4});async function s(e,t){let r=Date.now();try{let a=await c.query(e,t),o=Date.now()-r;return console.log("Executed query",{text:e,duration:o,rows:a.rowCount}),a}catch(t){throw console.error("Database query error:",{text:e,error:t}),t}}async function i(e){let t=await c.connect();try{await t.query("BEGIN");let r=await e(t);return await t.query("COMMIT"),r}catch(e){throw await t.query("ROLLBACK"),e}finally{t.release()}}c.on("error",e=>{console.error("Unexpected error on idle client",e),process.exit(-1)}),a()}catch(e){a(e)}})},4424:(e,t,r)=>{r.d(t,{D5:()=>d,TL:()=>p,m5:()=>c,po:()=>u,qg:()=>i});var a=r(4770),o=r.n(a);let n=process.env.PAYSTACK_SECRET_KEY,s="https://api.paystack.co";async function i(e){try{let t=await fetch(`${s}/transaction/initialize`,{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},body:JSON.stringify(e)}),r=await t.json();if(!t.ok)throw Error(r.message||"Failed to initialize payment");return r}catch(e){throw console.error("Paystack initialize payment error:",e),e}}async function c(e){try{let t=await fetch(`${s}/transaction/verify/${e}`,{method:"GET",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"}}),r=await t.json();if(!t.ok)throw Error(r.message||"Failed to verify payment");return r}catch(e){throw console.error("Paystack verify payment error:",e),e}}function u(e,t){if(!n)throw Error("PAYSTACK_SECRET_KEY not configured");return o().createHmac("sha512",n).update(e).digest("hex")===t}function p(e="AJO"){let t=Date.now();return`${e}-${t}-${Math.floor(1e6*Math.random())}`}function d(e){return Math.round(100*e)}n||console.warn("PAYSTACK_SECRET_KEY not set. Payment features will not work.")}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[276,972],()=>r(9778));module.exports=a})();