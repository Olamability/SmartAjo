"use strict";(()=>{var e={};e.id=526,e.ids=[526],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},8678:e=>{e.exports=import("pg")},6502:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>u,requestAsyncStorage:()=>m,routeModule:()=>l,serverHooks:()=>p,staticGenerationAsyncStorage:()=>d});var n=r(9303),s=r(8716),o=r(670),i=r(712),c=e([i]);i=(c.then?(await c)():c)[0];let l=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/payments/initiate/route",pathname:"/api/payments/initiate",filename:"route",bundlePath:"app/api/payments/initiate/route"},resolvedPagePath:"/home/runner/work/secured-ajo/secured-ajo/app/api/payments/initiate/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:m,staticGenerationAsyncStorage:d,serverHooks:p}=l,y="/api/payments/initiate/route";function u(){return(0,o.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:d})}a()}catch(e){a(e)}})},712:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{POST:()=>m});var n=r(2995),s=r(9434),o=r(3208),i=r(5874),c=r(4424),u=r(2596),l=e([n]);async function m(e){try{let t=await (0,i.k0)(e);if(t)return t;let r=await (0,s.ts)();if(!r)return(0,u.m)("Not authenticated");let a=await e.json(),l=o.hE.safeParse(a);if(!l.success)return(0,u.sm)(l.error.format());let{groupId:m,amount:d,type:p}=l.data,y=await (0,n.IO)(`SELECT g.id, g.name, g.contribution_amount, g.service_fee_percentage, gm.user_id
       FROM groups g
       LEFT JOIN group_members gm ON g.id = gm.group_id AND gm.user_id = $1
       WHERE g.id = $2`,[r.userId,m]);if(0===y.rows.length)return(0,u.VR)("Group not found",404);let w=y.rows[0];if(!w.user_id&&"contribution"===p)return(0,u.VR)("You are not a member of this group",403);let h=d*w.service_fee_percentage/100,g=d+h,f=(0,c.TL)("AJO");await (0,n.PS)(async e=>{if(await e.query(`INSERT INTO transactions 
         (user_id, group_id, type, amount, status, reference, payment_method, metadata)
         VALUES ($1, $2, $3, $4, $5, $6, $7, $8)`,[r.userId,m,p,g,"pending",f,"paystack",JSON.stringify({baseAmount:d,serviceFee:h,groupName:w.name})]),"contribution"===p){let t=await e.query("SELECT current_cycle FROM groups WHERE id = $1",[m]),a=t.rows[0]?.current_cycle||1;await e.query(`INSERT INTO contributions 
           (group_id, user_id, amount, cycle, status, due_date, service_fee, transaction_ref)
           VALUES ($1, $2, $3, $4, $5, CURRENT_TIMESTAMP, $6, $7)`,[m,r.userId,d,a,"pending",h,f])}});let _=(await (0,n.IO)("SELECT email FROM users WHERE id = $1",[r.userId])).rows[0].email,R=await (0,c.qg)({email:_,amount:(0,c.D5)(g),reference:f,callback_url:`${process.env.NEXT_PUBLIC_APP_URL}/payments/callback`,metadata:{userId:r.userId,groupId:m,type:p,baseAmount:d,serviceFee:h}});return(0,u.Xj)({authorization_url:R.data.authorization_url,access_code:R.data.access_code,reference:R.data.reference})}catch(e){return console.error("Initiate payment error:",e),(0,u.Vd)("Failed to initiate payment")}}n=(l.then?(await l)():l)[0],a()}catch(e){a(e)}})},2596:(e,t,r)=>{r.d(t,{VR:()=>s,Vd:()=>c,Xj:()=>n,m:()=>i,sm:()=>o});var a=r(7070);function n(e,t,r=200){return a.NextResponse.json({success:!0,data:e,message:t},{status:r})}function s(e,t=400,r){return a.NextResponse.json({success:!1,error:e,...r&&{details:r}},{status:t})}function o(e){return a.NextResponse.json({success:!1,error:"Validation failed",details:e},{status:422})}function i(e="Unauthorized"){return a.NextResponse.json({success:!1,error:e},{status:401})}function c(e="Internal server error"){return a.NextResponse.json({success:!1,error:e},{status:500})}},9434:(e,t,r)=>{r.d(t,{BV:()=>w,Gv:()=>m,I_:()=>_,P:()=>f,Wx:()=>h,c_:()=>l,ts:()=>g});var a=r(8691),n=r(6890),s=r(1463),o=r(1615);let i=new TextEncoder().encode(process.env.JWT_SECRET||"your-super-secret-jwt-key-min-32-characters"),c=process.env.JWT_ACCESS_TOKEN_EXPIRY||"15m",u=process.env.JWT_REFRESH_TOKEN_EXPIRY||"7d";async function l(e){return a.ZP.hash(e,12)}async function m(e,t){return a.ZP.compare(e,t)}async function d(e,t){return await new n.N({userId:e,email:t,type:"access"}).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime(c).sign(i)}async function p(e,t){return await new n.N({userId:e,email:t,type:"refresh"}).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime(u).sign(i)}async function y(e){try{let{payload:t}=await (0,s._)(e,i);return t}catch(e){throw Error("Invalid or expired token")}}async function w(e,t){let r=await d(e,t),a=await p(e,t),n=await (0,o.cookies)();return n.set("accessToken",r,{httpOnly:!0,secure:!0,sameSite:"lax",maxAge:900,path:"/"}),n.set("refreshToken",a,{httpOnly:!0,secure:!0,sameSite:"lax",maxAge:604800,path:"/"}),{accessToken:r,refreshToken:a}}async function h(){let e=await (0,o.cookies)();e.delete("accessToken"),e.delete("refreshToken")}async function g(){try{let e=await (0,o.cookies)(),t=e.get("accessToken")?.value;if(!t)return null;return await y(t)}catch(e){return null}}function f(){return Math.floor(1e5+9e5*Math.random()).toString()}function _(){let e=new Date;return e.setMinutes(e.getMinutes()+10),e}},2995:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{IO:()=>o,PS:()=>i});var n=r(8678),s=e([n]);if(n=(s.then?(await s)():s)[0],!process.env.DATABASE_URL)throw Error("DATABASE_URL environment variable is not set");let c=new n.Pool({connectionString:process.env.DATABASE_URL,ssl:{rejectUnauthorized:!1},max:20,idleTimeoutMillis:3e4,connectionTimeoutMillis:1e4});async function o(e,t){let r=Date.now();try{let a=await c.query(e,t),n=Date.now()-r;return console.log("Executed query",{text:e,duration:n,rows:a.rowCount}),a}catch(t){throw console.error("Database query error:",{text:e,error:t}),t}}async function i(e){let t=await c.connect();try{await t.query("BEGIN");let r=await e(t);return await t.query("COMMIT"),r}catch(e){throw await t.query("ROLLBACK"),e}finally{t.release()}}c.on("error",e=>{console.error("Unexpected error on idle client",e),process.exit(-1)}),a()}catch(e){a(e)}})},4424:(e,t,r)=>{r.d(t,{D5:()=>m,TL:()=>l,m5:()=>c,po:()=>u,qg:()=>i});var a=r(4770),n=r.n(a);let s=process.env.PAYSTACK_SECRET_KEY,o="https://api.paystack.co";async function i(e){try{let t=await fetch(`${o}/transaction/initialize`,{method:"POST",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"},body:JSON.stringify(e)}),r=await t.json();if(!t.ok)throw Error(r.message||"Failed to initialize payment");return r}catch(e){throw console.error("Paystack initialize payment error:",e),e}}async function c(e){try{let t=await fetch(`${o}/transaction/verify/${e}`,{method:"GET",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}}),r=await t.json();if(!t.ok)throw Error(r.message||"Failed to verify payment");return r}catch(e){throw console.error("Paystack verify payment error:",e),e}}function u(e,t){if(!s)throw Error("PAYSTACK_SECRET_KEY not configured");return n().createHmac("sha512",s).update(e).digest("hex")===t}function l(e="AJO"){let t=Date.now();return`${e}-${t}-${Math.floor(1e6*Math.random())}`}function m(e){return Math.round(100*e)}s||console.warn("PAYSTACK_SECRET_KEY not set. Payment features will not work.")},5874:(e,t,r)=>{r.d(t,{U0:()=>c,k0:()=>u});var a=r(7070);let n={},s=parseInt(process.env.RATE_LIMIT_WINDOW_MS||"900000"),o=parseInt(process.env.RATE_LIMIT_MAX_REQUESTS||"100");function i(e={}){let t=e.windowMs||s,r=e.maxRequests||o;return async e=>{let s=e.ip||e.headers.get("x-forwarded-for")||"unknown",o=Date.now();if(Object.keys(n).forEach(e=>{n[e].resetTime<o&&delete n[e]}),!n[s])return n[s]={count:1,resetTime:o+t},null;let i=n[s];if(i.resetTime<o)return i.count=1,i.resetTime=o+t,null;if(i.count>=r){let e=Math.ceil((i.resetTime-o)/1e3);return a.NextResponse.json({success:!1,error:"Too many requests",message:"You have exceeded the rate limit. Please try again later.",retryAfter:e},{status:429,headers:{"Retry-After":e.toString(),"X-RateLimit-Limit":r.toString(),"X-RateLimit-Remaining":"0","X-RateLimit-Reset":new Date(i.resetTime).toISOString()}})}return i.count++,null}}let c=i({windowMs:9e5,maxRequests:5});i({windowMs:9e5,maxRequests:100});let u=i({windowMs:6e4,maxRequests:10})},3208:(e,t,r)=>{r.d(t,{Ln:()=>o,dm:()=>s,hE:()=>u,if:()=>n,m7:()=>i,yC:()=>c});var a=r(1067);let n=a.Ry({fullName:a.Z_().min(2,"Full name must be at least 2 characters"),email:a.Z_().email("Invalid email address"),phone:a.Z_().min(10,"Phone number must be at least 10 digits"),password:a.Z_().min(8,"Password must be at least 8 characters").regex(/[A-Z]/,"Password must contain at least one uppercase letter").regex(/[a-z]/,"Password must contain at least one lowercase letter").regex(/[0-9]/,"Password must contain at least one number").regex(/[^A-Za-z0-9]/,"Password must contain at least one special character")}),s=a.Ry({email:a.Z_().email("Invalid email address"),password:a.Z_().min(1,"Password is required")}),o=a.Ry({email:a.Z_().email("Invalid email address"),otp:a.Z_().length(6,"OTP must be 6 digits")}),i=a.Ry({email:a.Z_().email("Invalid email address")});a.Ry({email:a.Z_().email("Invalid email address")}),a.Ry({token:a.Z_(),newPassword:a.Z_().min(8,"Password must be at least 8 characters").regex(/[A-Z]/,"Password must contain at least one uppercase letter").regex(/[a-z]/,"Password must contain at least one lowercase letter").regex(/[0-9]/,"Password must contain at least one number").regex(/[^A-Za-z0-9]/,"Password must contain at least one special character")});let c=a.Ry({fullName:a.Z_().min(2).optional(),phone:a.Z_().min(10).optional(),bvn:a.Z_().length(11).optional(),profileImage:a.Z_().url().optional()}),u=a.Ry({groupId:a.Z_().uuid("Invalid group ID"),amount:a.Rx().positive("Amount must be positive"),type:a.Km(["contribution","security_deposit"])});a.Ry({name:a.Z_().min(3,"Group name must be at least 3 characters"),description:a.Z_().optional(),contributionAmount:a.Rx().positive("Contribution amount must be positive"),frequency:a.Km(["daily","weekly","monthly"]),totalMembers:a.Rx().min(2).max(50),securityDepositPercentage:a.Rx().min(0).max(100),serviceFeePercentage:a.Rx().min(0).max(100).default(10),startDate:a.Z_().datetime().optional()}),a.Ry({groupId:a.Z_().uuid("Invalid group ID")})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[276,972,795,67],()=>r(6502));module.exports=a})();