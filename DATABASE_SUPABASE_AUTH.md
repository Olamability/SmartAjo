# Database Schema Notes for Supabase Auth

## Overview

After migrating to Supabase Auth, the database schema needs slight modifications to work seamlessly with Supabase's authentication system.

## Users Table Modifications

### Current Schema (Custom Auth)
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    email VARCHAR(255) NOT NULL UNIQUE,
    phone VARCHAR(20) NOT NULL,
    full_name VARCHAR(255) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,  -- ⚠️ No longer needed with Supabase Auth
    -- ... other fields
);
```

### Recommended Schema (Supabase Auth)
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY,  -- Use Supabase Auth user ID (no default)
    email VARCHAR(255) NOT NULL UNIQUE,
    phone VARCHAR(20) NOT NULL,
    full_name VARCHAR(255) NOT NULL,
    -- password_hash removed - Supabase Auth handles passwords
    is_verified BOOLEAN DEFAULT FALSE,
    kyc_status VARCHAR(20) DEFAULT 'not_started',
    bvn VARCHAR(11),
    profile_image TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP WITH TIME ZONE,
    email_verified_at TIMESTAMP WITH TIME ZONE,
    phone_verified_at TIMESTAMP WITH TIME ZONE,
    is_active BOOLEAN DEFAULT TRUE
    -- failed_login_attempts and locked_until removed - Supabase Auth handles this
);
```

### Migration Steps

#### Option 1: Fresh Install (Recommended for new deployments)

1. Use the modified schema above when creating your database
2. The `id` field will be populated from Supabase Auth user IDs during signup

#### Option 2: Migrate Existing Database

```sql
-- Backup your database first!
-- pg_dump $DATABASE_URL > backup.sql

-- Step 1: Make password_hash nullable (temporary)
ALTER TABLE users ALTER COLUMN password_hash DROP NOT NULL;

-- Step 2: Remove columns that Supabase Auth handles
-- (Optional - you can keep them but they won't be used)
-- ALTER TABLE users DROP COLUMN password_hash;
-- ALTER TABLE users DROP COLUMN failed_login_attempts;
-- ALTER TABLE users DROP COLUMN locked_until;

-- Step 3: Ensure id column doesn't auto-generate
ALTER TABLE users ALTER COLUMN id DROP DEFAULT;

-- Step 4: Clear existing users (they need to re-register with Supabase Auth)
-- WARNING: This will delete all user data!
-- TRUNCATE users CASCADE;
```

## Signup Process

### With Supabase Auth

When a user signs up:

1. **Supabase Auth creates the user:**
   ```typescript
   const { data, error } = await supabase.auth.signUp({
     email,
     password,
     options: {
       data: { full_name: fullName, phone: phone }
     }
   });
   ```
   - User created in `auth.users` table (managed by Supabase)
   - User ID generated by Supabase (UUID format)

2. **Your app creates profile:**
   ```typescript
   await query(
     `INSERT INTO users (id, email, phone, full_name, is_verified, is_active)
      VALUES ($1, $2, $3, $4, $5, $6)`,
     [data.user.id, email, phone, fullName, false, true]
   );
   ```
   - Use Supabase user ID as primary key
   - No password storage needed
   - Profile data stored in your `users` table

## Key Differences

| Aspect | Custom Auth | Supabase Auth |
|--------|-------------|---------------|
| User ID | Auto-generated UUID | Supabase Auth user ID |
| Password Storage | `password_hash` in users table | Managed by Supabase |
| Login Attempts | Tracked in users table | Managed by Supabase |
| Account Locking | `locked_until` in users table | Managed by Supabase |
| Session Management | Custom JWT cookies | Supabase Auth cookies |
| Email Verification | Custom OTP system | Can use Supabase (optional) |

## Email Verification

You have two options for email verification:

### Option 1: Keep Custom OTP System (Current Implementation)
- Continue using `email_verification_tokens` table
- Send custom OTP codes
- Verify with your own logic
- ✅ More control over verification process
- ✅ Works with existing code

### Option 2: Use Supabase Email Verification
- Configure Supabase email templates
- Supabase sends verification emails
- Auto-verify on email confirmation
- ✅ One less thing to manage
- ❌ Requires email configuration in Supabase

**Recommendation:** Keep custom OTP system for now (less migration work).

## Supabase Auth Tables

Supabase manages these tables in the `auth` schema:

- `auth.users` - Core user authentication data
- `auth.sessions` - Active sessions
- `auth.refresh_tokens` - Refresh tokens for session renewal
- `auth.identities` - OAuth identities (if using OAuth)

**Important:** Don't modify these tables directly. Use Supabase Auth API.

## Row Level Security (RLS)

If you want to use Supabase's Row Level Security:

```sql
-- Enable RLS on users table
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- Policy: Users can read their own profile
CREATE POLICY "Users can read own profile"
  ON users
  FOR SELECT
  USING (auth.uid() = id);

-- Policy: Users can update their own profile
CREATE POLICY "Users can update own profile"
  ON users
  FOR UPDATE
  USING (auth.uid() = id);

-- Policy: Users can insert their profile
CREATE POLICY "Users can insert own profile"
  ON users
  FOR INSERT
  WITH CHECK (auth.uid() = id);
```

**Note:** RLS is optional. Your API routes already handle authorization.

## Checklist for Database Migration

- [ ] Backup existing database
- [ ] Decide: fresh install or migrate existing users
- [ ] Update users table schema (remove password_hash, etc.)
- [ ] Test signup flow (creates user in both Supabase Auth and users table)
- [ ] Test login flow (authenticates against Supabase)
- [ ] Test profile updates
- [ ] Test all protected API routes
- [ ] Verify foreign key constraints still work

## Common Issues

### Issue: "duplicate key value violates unique constraint"

**Cause:** Trying to create a user with an ID that already exists.

**Solution:**
```typescript
// Always use Supabase's generated user ID
const supabaseUser = await supabase.auth.signUp({...});
await query('INSERT INTO users (id, ...) VALUES ($1, ...)', [supabaseUser.data.user.id, ...]);
```

### Issue: "null value in column 'password_hash'"

**Cause:** Old schema requires password_hash.

**Solution:**
```sql
ALTER TABLE users ALTER COLUMN password_hash DROP NOT NULL;
-- Or remove the column entirely
```

### Issue: "User not found" after successful Supabase login

**Cause:** User exists in Supabase Auth but not in your users table.

**Solution:**
- Ensure signup creates entries in both places
- Check if user was created in Supabase but profile creation failed
- May need to manually sync

## Testing Database Changes

```bash
# Connect to your database
psql $DATABASE_URL

# Check users table structure
\d users

# Check if password_hash is nullable
SELECT column_name, is_nullable FROM information_schema.columns 
WHERE table_name = 'users' AND column_name = 'password_hash';

# Check if any users exist
SELECT id, email, created_at FROM users LIMIT 5;
```

## Rollback Plan

If you need to rollback to custom JWT auth:

1. Restore from backup: `psql $DATABASE_URL < backup.sql`
2. Checkout previous git commit
3. Restore old .env.local with JWT_SECRET
4. Redeploy

**Note:** Users who signed up with Supabase Auth will need to re-register.

## Additional Resources

- [Supabase Auth Schema](https://supabase.com/docs/guides/auth/auth-schema)
- [Supabase User Management](https://supabase.com/docs/guides/auth/managing-user-data)
- [Row Level Security](https://supabase.com/docs/guides/auth/row-level-security)
